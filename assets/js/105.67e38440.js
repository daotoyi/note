(window.webpackJsonp=window.webpackJsonp||[]).push([[105],{586:function(s,e,t){"use strict";t.r(e);var n=t(20),a=Object(n.a)({},(function(){var s=this,e=s.$createElement,t=s._self._c||e;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("Linux_systemd_serivice")]),s._v(" "),t("p",[s._v("[toc]")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://www.cnblogs.com/jhxxb/p/10654554.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("Systemd 添加自定义服务(开机自启动)"),t("OutboundLink")],1)]),s._v(" "),t("h1",{attrs:{id:"basic"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#basic"}},[s._v("#")]),s._v(" basic")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("systemctl enable mysqld\nsystemctl disable mysqld\nsystemctl start mysqld\nsystemctl stop mysqld\nsystemctl restart mysqld\nsystemctl status mysqld\nsystemctl is-active sshd.service\nsystemctl kill mysqld  # 结束服务进程(服务无法停止时)\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("h1",{attrs:{id:"example"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#example"}},[s._v("#")]),s._v(" example")]),s._v(" "),t("blockquote",[t("p",[s._v("systemctl cat sshd.service")])]),s._v(" "),t("p",[t("code",[s._v("/usr/lib/systemd/system/sshd.service")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("[Unit]\nDescription=OpenSSH server daemon\nDocumentation=man:sshd(8) man:sshd_config(5)\nAfter=network.target sshd-keygen.service\nWants=sshd-keygen.service\n\n[Service]\nType=notify\nEnvironmentFile=/etc/sysconfig/sshd\nExecStart=/usr/sbin/sshd -D $OPTIONS\nExecReload=/bin/kill -HUP $MAINPID\nKillMode=process\nRestart=on-failure\nRestartSec=42s\n\n[Install]\nWantedBy=multi-user.target\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("h2",{attrs:{id:"unit"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#unit"}},[s._v("#")]),s._v(" [Unit]")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("Description：当前服务的简单描述")])]),s._v(" "),t("li",[t("p",[s._v("After：sshd.service 在 network.target 或 sshd-keygen.service 之后启动")])]),s._v(" "),t("li",[t("p",[s._v("Before：定义 sshd 应该在哪些服务之前启动")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("注意")]),s._v("：After 和 Before 字段只涉及启动顺序，不涉及依赖关系。")])])]),s._v(" "),t("li",[t("p",[s._v('Wants：存在"弱依赖"关系，即如果"sshd-keygen.service"启动失败或停止运行，不影响 sshd.service 继续执行。')])]),s._v(" "),t("li",[t("p",[s._v('Requires：表示"强依赖"关系，即如果该服务启动失败或异常退出，那么sshd.service 也必须退出。')]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("注意")]),s._v("：Wants 字段与 Requires 字段只涉及依赖关系，与启动顺序无关，默认情况下是同时启动。")])])])]),s._v(" "),t("h2",{attrs:{id:"service"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#service"}},[s._v("#")]),s._v(" [Service]")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("EnvironmentFile：许多软件都有自己的环境参数文件，该字段指定文件路径")])]),s._v(" "),t("li",[t("p",[s._v("Type：定义启动类型。可设置：simple，exec，forking，oneshot，dbus，notify，idle")]),s._v(" "),t("ul",[t("li",[s._v("simple(设置了 ExecStart= 但未设置 BusName= 时的默认值)：ExecStart 字段启动的进程为该服务的主进程")]),s._v(" "),t("li",[s._v("forking：ExecStart 字段的命令将以 fork() 方式启动，此时父进程将会退出，子进程将成为主进程")])])]),s._v(" "),t("li",[t("p",[s._v("ExecStart：定义启动进程时执行的命令")])]),s._v(" "),t("li",[t("p",[s._v("上面的例子中，启动 sshd 执行的命令是 /usr/sbin/sshd -D $OPTIONS，其中的变量 $OPTIONS 就来自 EnvironmentFile 字段指定的环境参数文件。类似的，还有如下字段：")])]),s._v(" "),t("li",[t("p",[s._v("ExecReload：重启服务时执行的命令")])]),s._v(" "),t("li",[t("p",[s._v("ExecStop：停止服务时执行的命令")])]),s._v(" "),t("li",[t("p",[s._v("ExecStartPre：启动服务之前执行的命令")])]),s._v(" "),t("li",[t("p",[s._v("ExecStartPost：启动服务之后执行的命令")])]),s._v(" "),t("li",[t("p",[s._v("ExecStopPost：停止服务之后执行的命令")])]),s._v(" "),t("li",[t("p",[s._v("RemainAfterExit：设为yes，表示进程退出以后，服务仍然保持执行")])]),s._v(" "),t("li",[t("p",[s._v("KillMode：定义 Systemd 如何停止服务，可以设置的值如下：")])]),s._v(" "),t("li",[t("p",[s._v("control-group（默认值）：当前控制组里面的所有子进程，都会被杀掉")])]),s._v(" "),t("li",[t("p",[s._v("process：只杀主进程")])]),s._v(" "),t("li",[t("p",[s._v("mixed：主进程将收到 SIGTERM 信号，子进程收到 SIGKILL 信号")])]),s._v(" "),t("li",[t("p",[s._v("none：没有进程会被杀掉，只是执行服务的 stop 命令")])]),s._v(" "),t("li",[t("p",[s._v("Restart：定义了退出后，Systemd 的重启方式。可以设置的值如下：")])]),s._v(" "),t("li",[t("p",[s._v("no（默认值）：退出后不会重启")])]),s._v(" "),t("li",[t("p",[s._v("on-success：只有正常退出时（退出状态码为0），才会重启")])]),s._v(" "),t("li",[t("p",[s._v("on-failure：非正常退出时（退出状态码非0），包括被信号终止和超时，才会重启")])]),s._v(" "),t("li",[t("p",[s._v("on-abnormal：只有被信号终止和超时，才会重启")])]),s._v(" "),t("li",[t("p",[s._v("on-abort：只有在收到没有捕捉到的信号终止时，才会重启")])]),s._v(" "),t("li",[t("p",[s._v("on-watchdog：超时退出，才会重启")])]),s._v(" "),t("li",[t("p",[s._v("always：不管是什么退出原因，总是重启")])]),s._v(" "),t("li",[t("p",[s._v("RestartSec：表示 Systemd 重启服务之前，需要等待的秒数")])])]),s._v(" "),t("p",[s._v('所有的启动设置之前，都可以加上一个连词号（-），表示"抑制错误"，即发生错误的时候，不影响其他命令的执行:'),t("code",[s._v("EnvironmentFile=-/etc/sysconfig/sshd")])]),s._v(" "),t("h2",{attrs:{id:"install"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#install"}},[s._v("#")]),s._v(" [Install]")]),s._v(" "),t("ul",[t("li",[s._v("WantedBy：表示该服务所在的 Target(服务组)")]),s._v(" "),t("li",[s._v("常用的 Target 有两个：\n"),t("ul",[t("li",[s._v("一个是 multi-user.target，表示多用户命令行状态；")]),s._v(" "),t("li",[s._v("一个是 graphical.target，表示图形用户状态，它依赖于 multi-user.target")])])])]),s._v(" "),t("h1",{attrs:{id:"e-g-simple"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#e-g-simple"}},[s._v("#")]),s._v(" e.g.(simple)")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("[Unit]\nDescription=Telnet Service\nAfter=network.target\n\n[Service]\nType=forking\nExecStart=/sbin/telnetd -p 23\n\n[Install]\nWantedBy=multi-user.target\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])])])}),[],!1,null,null,null);e.default=a.exports}}]);